name: Check New Data and Trigger Training

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  check-and-train:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Check data count
        id: check
        run: |
          cd src
          COUNT=$(python -c "from data_manager import get_data_count; print(get_data_count())")
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "Current data count: $COUNT"
          
          if [ "$COUNT" -ge 200 ]; then
            echo "trigger=true" >> $GITHUB_OUTPUT
            echo "[OK] Threshold met"
          else
            echo "trigger=false" >> $GITHUB_OUTPUT
            echo "[WAIT] Not enough data yet"
          fi
      
      - name: Run model training
        if: steps.check.outputs.trigger == 'true'
        run: |
          cd src
          python train.py
      
      - name: Check if model improved
        if: steps.check.outputs.trigger == 'true'
        id: model_check
        run: |
          if [ "${{ env.MODEL_IMPROVED }}" == "true" ]; then
            echo "improved=true" >> $GITHUB_OUTPUT
            echo "new_version=${{ env.NEW_VERSION }}" >> $GITHUB_OUTPUT
            echo "new_accuracy=${{ env.NEW_ACCURACY }}" >> $GITHUB_OUTPUT
            echo "old_accuracy=${{ env.OLD_ACCURACY }}" >> $GITHUB_OUTPUT
            echo "model_file=${{ env.MODEL_FILE }}" >> $GITHUB_OUTPUT
          else
            echo "improved=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Configure git
        if: steps.model_check.outputs.improved == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
      
      - name: Create branch and commit
        if: steps.model_check.outputs.improved == 'true'
        run: |
          BRANCH_NAME="model-update-v${{ steps.model_check.outputs.new_version }}-$(date +%Y%m%d-%H%M%S)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          
          git checkout -b $BRANCH_NAME
          git add model/${{ steps.model_check.outputs.model_file }}
          git add model/model_metadata.json
          git add data/new_data_counter.json
          git commit -m "Auto-update: Model v${{ steps.model_check.outputs.new_version }}"
          git push origin $BRANCH_NAME
      
      - name: Create Pull Request
        if: steps.model_check.outputs.improved == 'true'
        run: |
          gh pr create \
           --title "Model v${{ steps.model_check.outputs.new_version }} (Acc: ${{ steps.model_check.outputs.new_accuracy }}%)" \
            --body "Automated model update. New accuracy: ${{ steps.model_check.outputs.new_accuracy }}%" \
            --base main
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      
      - name: Enable auto-merge
        if: steps.model_check.outputs.improved == 'true'
        run: |
          sleep 5
          PR_NUMBER=$(gh pr list --head ${{ env.BRANCH_NAME }} --json number --jq '.[0].number')
          gh pr merge $PR_NUMBER --auto --squash
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      
      - name: Report status
        run: |
          if [ "${{ steps.check.outputs.trigger }}" == "true" ]; then
            echo "Training completed"
          else
            echo "Waiting for more data"
          fi
