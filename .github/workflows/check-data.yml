name: Check New Data and Trigger Training

on:
  # Run every hour to check for new data
  schedule:
    - cron: '0 * * * *'  # Every hour at minute 0
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  check-and-train:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Check data count
        id: check
        run: |
          cd src
          COUNT=$(python -c "from data_manager import get_data_count; print(get_data_count())")
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "Current data count: $COUNT"
          
          if [ "$COUNT" -ge 200 ]; then
            echo "trigger=true" >> $GITHUB_OUTPUT
            echo "[OK] Threshold met! Triggering training..."
          else
            echo "trigger=false" >> $GITHUB_OUTPUT
            echo "[WAIT] Not enough data yet ($COUNT/200)"
          fi
      
      - name: Run model training
        if: steps.check.outputs.trigger == 'true'
        id: train
        run: |
          cd src
          python train.py
      
      - name: Check if model improved
        if: steps.check.outputs.trigger == 'true'
        id: model_check
        run: |
          if [ "${{ env.MODEL_IMPROVED }}" == "true" ]; then
            echo "improved=true" >> $GITHUB_OUTPUT
            echo "new_version=${{ env.NEW_VERSION }}" >> $GITHUB_OUTPUT
            echo "new_accuracy=${{ env.NEW_ACCURACY }}" >> $GITHUB_OUTPUT
            echo "old_accuracy=${{ env.OLD_ACCURACY }}" >> $GITHUB_OUTPUT
            echo "model_file=${{ env.MODEL_FILE }}" >> $GITHUB_OUTPUT
            echo "[SUCCESS] Model improved! Creating PR..."
          else
            echo "improved=false" >> $GITHUB_OUTPUT
            echo "[INFO] Model did not improve. No PR will be created."
          fi
      
      - name: Configure git
        if: steps.model_check.outputs.improved == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
      
      - name: Create branch and commit new model
        if: steps.model_check.outputs.improved == 'true'
        run: |
          BRANCH_NAME="model-update-v${{ steps.model_check.outputs.new_version }}-$(date +%Y%m%d-%H%M%S)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          
          git checkout -b $BRANCH_NAME
          git add model/${{ steps.model_check.outputs.model_file }}
          git add model/model_metadata.json
          git add data/new_data_counter.json
          
          # Create commit message
          COMMIT_MSG="Auto-update: Model v${{ steps.model_check.outputs.new_version }}
          
          Performance Improvement:
          - New Accuracy: ${{ steps.model_check.outputs.new_accuracy }}%
          - Previous Accuracy: ${{ steps.model_check.outputs.old_accuracy }}%
          
          Auto-generated by CI/CD pipeline"
          
          git commit -m "$COMMIT_MSG"
          
          git push origin $BRANCH_NAME
      
      - name: Create Pull Request
        if: steps.model_check.outputs.improved == 'true'
        uses: peter-evans/create-pull-request@v5
        id: create-pr
        with:
          token: ${{ secrets.PAT_TOKEN }}
          branch: ${{ env.BRANCH_NAME }}
          title: "Auto-update Model to v${{ steps.model_check.outputs.new_version }}"
          body: |
            ## Automated Model Update
            
            This PR was automatically created by the CI/CD pipeline after detecting improved model performance.
            
            ### Performance Metrics
            
            | Metric | Old Model | New Model |
            |--------|-----------|-----------|  
            | **Accuracy** | ${{ steps.model_check.outputs.old_accuracy }}% | ${{ steps.model_check.outputs.new_accuracy }}% |
            | **Version** | v${{ env.OLD_VERSION }} | v${{ steps.model_check.outputs.new_version }} |
            
            ### Quality Gates Passed
            
            - [x] Model trained on 200+ new user datasets
            - [x] Accuracy improved over previous version
            - [x] Model validation completed
            - [x] Metadata updated
            
            ### Changes Included
            
            - New model file: `model/${{ steps.model_check.outputs.model_file }}`
            - Updated model metadata
            - Reset data counter
            
            ### Next Steps
            
            This PR will be automatically merged if all checks pass.
            
            ---
            *Generated by GitHub Actions - Auto-Train Pipeline*
          labels: |
            model-update
            automated
            bot
          draft: false
      
      - name: Enable auto-merge
        if: steps.model_check.outputs.improved == 'true'
        run: |
          # Wait a moment for PR to be created
          sleep 5
          
          # Get PR number
          PR_NUMBER=$(gh pr list --head ${{ env.BRANCH_NAME }} --json number --jq '.[0].number')
          
          echo "PR Number: $PR_NUMBER"
          
          # Enable auto-merge
          gh pr merge $PR_NUMBER --auto --squash
          
          echo "[OK] Auto-merge enabled for PR #$PR_NUMBER"
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      
      - name: Report status
        run: |
          if [ "${{ steps.check.outputs.trigger }}" == "true" ]; then
            if [ "${{ steps.model_check.outputs.improved }}" == "true" ]; then
              echo "[SUCCESS] Training completed and PR created!"
            else
              echo "[INFO] Training completed but model did not improve."
            fi
          else
            echo "[WAIT] Waiting for more data. Current: ${{ steps.check.outputs.count }}/200"
          fi
