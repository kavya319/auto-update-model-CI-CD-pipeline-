name: Auto Train and Create PR

on:
  # Triggered by check-data workflow
  repository_dispatch:
    types: [trigger-training]
  
  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  train-and-pr:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run model training
        id: train
        run: |
          cd src
          python train.py
      
      - name: Check if model improved
        id: check
        run: |
          if [ "${{ env.MODEL_IMPROVED }}" == "true" ]; then
            echo "improved=true" >> $GITHUB_OUTPUT
            echo "new_version=${{ env.NEW_VERSION }}" >> $GITHUB_OUTPUT
            echo "new_accuracy=${{ env.NEW_ACCURACY }}" >> $GITHUB_OUTPUT
            echo "old_accuracy=${{ env.OLD_ACCURACY }}" >> $GITHUB_OUTPUT
            echo "model_file=${{ env.MODEL_FILE }}" >> $GITHUB_OUTPUT
          else
            echo "improved=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Configure git
        if: steps.check.outputs.improved == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
      
      - name: Create branch and commit new model
        if: steps.check.outputs.improved == 'true'
        run: |
          BRANCH_NAME="model-update-v${{ steps.check.outputs.new_version }}-$(date +%Y%m%d-%H%M%S)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          
          git checkout -b $BRANCH_NAME
          git add model/${{ steps.check.outputs.model_file }}
          git add model/model_metadata.json
          git add data/new_data_counter.json
          
          git commit -m "ü§ñ Auto-update: Model v${{ steps.check.outputs.new_version }}
          
          Performance Improvement Detected:
          - New Accuracy: ${{ steps.check.outputs.new_accuracy }}%
          - Previous Accuracy: ${{ steps.check.outputs.old_accuracy }}%
          - Improvement: +$(echo '${{ steps.check.outputs.new_accuracy }} - ${{ steps.check.outputs.old_accuracy }}' | bc)%
          
          This model was trained automatically and passed quality gates.
          Auto-generated by CI/CD pipeline."
          
          git push origin $BRANCH_NAME
      
      - name: Create Pull Request
        if: steps.check.outputs.improved == 'true'
        uses: peter-evans/create-pull-request@v5
        id: create-pr
        with:
          token: ${{ secrets.PAT_TOKEN }}
          branch: ${{ env.BRANCH_NAME }}
          title: "ü§ñ Auto-update Model to v${{ steps.check.outputs.new_version }}"
          body: |
            ## üéØ Automated Model Update
            
            This PR was automatically created by the CI/CD pipeline after detecting improved model performance.
            
            ### üìä Performance Metrics
            
            | Metric | Old Model | New Model | Change |
            |--------|-----------|-----------|--------|
            | **Accuracy** | ${{ steps.check.outputs.old_accuracy }}% | ${{ steps.check.outputs.new_accuracy }}% | +$(echo '${{ steps.check.outputs.new_accuracy }} - ${{ steps.check.outputs.old_accuracy }}' | bc)% |
            | **Version** | v${{ env.OLD_VERSION }} | v${{ steps.check.outputs.new_version }} | - |
            
            ### ‚úÖ Quality Gates Passed
            
            - [x] Model trained on 200+ new user datasets
            - [x] Accuracy improved over previous version
            - [x] Model validation completed
            - [x] Metadata updated
            
            ### üîÑ Changes Included
            
            - New model file: `model/${{ steps.check.outputs.model_file }}`
            - Updated model metadata
            - Reset data counter
            
            ### üöÄ Next Steps
            
            This PR will be automatically merged if all checks pass.
            
            ---
            *Generated by GitHub Actions - Auto-Train Pipeline*
          labels: |
            model-update
            automated
            bot
          draft: false
      
      - name: Enable auto-merge
        if: steps.check.outputs.improved == 'true'
        run: |
          # Wait a moment for PR to be created
          sleep 5
          
          # Get PR number
          PR_NUMBER=$(gh pr list --head ${{ env.BRANCH_NAME }} --json number --jq '.[0].number')
          
          echo "PR Number: $PR_NUMBER"
          
          # Enable auto-merge
          gh pr merge $PR_NUMBER --auto --squash
          
          echo "‚úÖ Auto-merge enabled for PR #$PR_NUMBER"
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      
      - name: Report no improvement
        if: steps.check.outputs.improved == 'false'
        run: |
          echo "‚ÑπÔ∏è Model training completed but did not show improvement."
          echo "No PR will be created. The current model remains in production."
