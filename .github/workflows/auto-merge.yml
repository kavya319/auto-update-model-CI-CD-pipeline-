name: Auto-Approve and Merge Model Updates

on:
  pull_request:
    types: [opened, labeled]

jobs:
  auto-approve:
    # Only run on PRs with the 'model-update' label
    if: contains(github.event.pull_request.labels.*.name, 'model-update')
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: write
      contents: write
    
    steps:
      - name: Check PR labels
        run: |
          echo "PR #${{ github.event.pull_request.number }}"
          echo "Labels: ${{ join(github.event.pull_request.labels.*.name, ', ') }}"
          echo "This PR has the 'model-update' label - will auto-approve and merge"
      
      - name: Approve Pull Request
        uses: hmarr/auto-approve-action@v3
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
      
      - name: Enable auto-merge
        run: |
          gh pr merge ${{ github.event.pull_request.number }} --auto --squash --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      
      - name: Add approval comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **Auto-approved by CI/CD Pipeline**\n\nThis model update PR has been automatically approved and will merge when all checks pass.'
            })
